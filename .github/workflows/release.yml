name: Release

# Trigger on version tags (e.g., v2.1.0, v2.1.1, v3.0.0)
on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write  # For trusted publishing to PyPI

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build

      - name: Check package
        run: |
          twine check dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: false
          name: Release v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Installation

            ```bash
            pip install claude-force==${{ steps.get_version.outputs.VERSION }}
            ```

            ## What's Changed

            See full changelog: [CHANGELOG_V2.1.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG_V2.1.md)

            ## Documentation

            - [Installation Guide](https://github.com/${{ github.repository }}/blob/main/docs/installation.md)
            - [Quick Start](https://github.com/${{ github.repository }}/blob/main/QUICK_START.md)
            - [API Documentation](https://github.com/${{ github.repository }}/blob/main/docs/api-reference/index.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages (Optional)
        if: false  # Set to true to enable
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://upload.pypi.org/legacy/
          password: ${{ secrets.GITHUB_TOKEN }}
